# Load from exisitng image
ARG NVIDIA=22.12

FROM nvcr.io/nvidia/pytorch:$NVIDIA-py3 

# Install sudo
RUN apt-get update && apt-get -y install sudo

# Set arguments
ARG USER
ARG UID

# Set environment variables
ENV HOME                /workspace

# Create user and setup permissions on /etc/sudoers
RUN groupadd -r -g $UID $USER && \
    groupadd -r -g 17131 rsg && \
    useradd -s /bin/bash -N -u $UID -g $USER $USER && \
    usermod -a -G rsg $USER && \
    echo "${USER} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers && \
    chmod 0440 /etc/sudoers && \
    chmod g+w /etc/passwd && \
    usermod -d $HOME $USER 

RUN ["apt-get", "install", "-y", "zsh"]
RUN wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | zsh || true
RUN curl -sS https://starship.rs/install.sh && \
    sh $HOME/install.sh

RUN echo "export PATH=$PATH:{HOME}/.local/bin" >> $HOME/.zshrc && \
    echo "alias gtnox=\"cd /Mounts/rbg-storage1/users/itamarc/nox\"" >> $HOME/.zshrc && \
    echo "alias gtitamarc=\"cd /Mounts/rbg-storage1/users/itamarc\""  >> $HOME/.zshrc && \
    echo "alias jl=\"jupyter lab\"" >> $HOME/.zshrc && \
    echo "eval \"$(starship init bash)\"" >> $HOME/.zshrc


RUN /bin/zsh /home/main/.zshrc

COPY nox_requirements.txt /workspace/nox_requirements.txt

RUN pip install --no-cache-dir -r /workspace/nox_requirements.txt
# Command on start
# CMD ["bash"]
CMD ["zsh"]

# Set workdir and switch back to non-root user
WORKDIR $HOME
USER $UID
